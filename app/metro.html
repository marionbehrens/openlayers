<!DOCTYPE html>
<html>

<head>
  <title>berlin_metro</title>
  <meta http-equiv="imagetoolbar" content="no" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style type="text/css">
    .popover-content {
      min-width: 180px;
    }
    
    .map {
      width: 100%;
      height: 400px;
    }
    
    .edit-form input {
      float: left;
    }
  </style>
  <link rel="stylesheet" href="../bower_components/openlayers3/ol.css" type="text/css">
  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
  <script src="../bower_components/openlayers3/ol.js" type="text/javascript"></script>
  <script src="../bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
  <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="./polygon.js" type="text/javascript"></script>
  <script src="./points.js" type="text/javascript"></script>
  <script src="./geojson.js" type="text/javascript"></script>
  <!-- script src="./selection.js" type="text/javascript"></script -->
</head>

<body>
  <div id="map" class="map"></div>
  <div style="display: none;">
    <div id="popup" title="Welcome to ol3"></div>
  </div>
  <div id="mouse-position"></div>
  <div class="edit-form">
    <input id="switch-projection" type="button" value="Switch" />
    <input id="toggle-debug" type="checkbox" />Debug-Mode
    <input id="toggle-select" type="checkbox" />Select-Mode
  </div>
  <script type="text/javascript">

    var imageMapExtent = [0.000000, -4437.000000, 6445.000000, 0.000000];
    // var osmMapExtent = [13.0, 52.115.000000, 13.8, 52.915]; // 13.400, 52.515
    var mapMinZoom = 0;
    var mapMaxZoom = 5;
    var mapMaxResolution = 1.000000;
    var tileExtent = [0.000000, -4437.000000, 6445.000000, 0.000000];

    var mapResolutions = [];
    for (var z = mapMinZoom; z <= mapMaxZoom; z++) {
      mapResolutions.push(Math.pow(2, mapMaxZoom - z) * mapMaxResolution);
    }

    var mapTileGrid = new ol.tilegrid.TileGrid({
      extent: tileExtent,
      minZoom: mapMinZoom,
      resolutions: mapResolutions
    });

    var imageLayer = new ol.layer.Tile({
      source: new ol.source.XYZ({
        projection: 'PIXELS',
        tileGrid: mapTileGrid,
        url: "{z}/{x}/{y}.png"
      })
    });

    var imageView = new ol.View({
      projection: ol.proj.get('PIXELS'),
      extent: imageMapExtent,
      maxResolution: mapTileGrid.getResolution(0)
    });

    var osmLayer = new ol.layer.Tile({
      source: new ol.source.OSM()
    });

    var osmView = new ol.View({
      // projection: 'EPSG:4326',
      center: ol.proj.transform([13.400, 52.515], 'EPSG:4326', 'EPSG:3857'),
      zoom: 11
    });

    var map;

    var projection = 'PIXELS';

    var mousePosition = new ol.control.MousePosition({
      coordinateFormat: ol.coordinate.createStringXY(4),
      projection: 'PIXELS',
      // comment the following two lines to have the mouse position
      // be placed within the map.
      className: 'custom-mouse-position',
      target: document.getElementById('mouse-position'),
      undefinedHTML: '&nbsp;'
    });

    var mousePositionControl = ol.control.defaults({
      attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
        collapsible: false
      })
    }).extend([mousePosition]);

    var popup = new ol.Overlay({
      element: document.getElementById('popup')
    });

    var currentLayers = [];

    var switchProjection = function() {
      if (map) {
        if (currentLayers && (currentLayers.length > 0)) {
          currentLayers.forEach(function(layer) {
            map.removeLayer(layer);
          });
          currentLayers = [];
        }
        removePopup();
      } else {
        map = new ol.Map({
          target: 'map',
          renderer: 'canvas',
          layers: [],
          controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
              collapsible: false
            })
          }).extend([mousePosition, new ol.control.OverviewMap()])
        });
        map.addOverlay(popup);
      }
      if (projection == 'PIXELS') {
        map.setView(osmView);
        mousePosition.setProjection(ol.proj.get('EPSG:4326'));
        currentLayers.push(osmLayer);
        // currentLayers.push(getPolygonLayer('EPSG:3857'));
        currentLayers.push(getGeoJsonLayer('EPSG:3857'));
        // currentLayers.push(vectorLayer);
        projection = 'EPSG:3857';
      } else {
        map.setView(imageView);
        mousePosition.setProjection(ol.proj.get('PIXELS'));
        currentLayers.push(imageLayer);
        // currentLayers.push(getPolygonLayer('PIXELS'));
        currentLayers.push(getGeoJsonLayer('PIXELS'));
        // currentLayers.push(vectorLayer);
        map.getView().fit(imageMapExtent, map.getSize());
        projection = 'PIXELS';
      }
      currentLayers.forEach(function(layer) {
        map.addLayer(layer);
      });
    }


    var draw;

    function addInteraction() {
      if (map) {
        draw = new ol.interaction.Draw({
          type: 'Polygon',
          maxPoints: 10
        });
        map.addInteraction(draw);
      }
    }

    function removeInteraction() {
      if (map) {
        map.removeInteraction(draw);
      }
    }


    switchProjection();

    $('#switch-projection').click(function() {
      switchProjection();
    });

    var isDebug = false;
    $('#toggle-debug').prop("checked", false);

    $('#toggle-debug').click(function() {
      isDebug = $('#toggle-debug').prop("checked");
    });

    $('#toggle-select').prop("checked", false);

    $('#toggle-select').click(function() {
      if ($('#toggle-select').prop("checked")) {
        addInteraction();
      } else {
        removeInteraction();
      }
    });

    map.on('dblclick', function(evt) {
      console.log(isDebug);
      if (isDebug) {
        var element = popup.getElement();
        var coord = evt.coordinate;
        removePopup();
        popup.setPosition(coord);
        if (projection == 'EPSG:3857') {
          coord = ol.proj.transform(coord, 'EPSG:3857', 'EPSG:4326');
        }
        $(element).popover({
          'placement': 'top',
          'animation': false,
          'html': true,
          'content': '<p>{<br>&nbsp;\"type\":\"Feature\",<br>&nbsp;\"properties\": {<br>&nbsp;&nbsp;\"name\": \"XYZ\"<br>&nbsp;},<br>&nbsp;\"geometry\": {<br>&nbsp;&nbsp;\"type\": \"Point\",<br>&nbsp;&nbsp;\"coordinates\": [<br>&nbsp;&nbsp;&nbsp;' + coord[0] + ',<br>&nbsp;&nbsp;&nbsp;' + coord[1] + '<br>&nbsp;&nbsp;]<br>&nbsp;}<br>}</p>'
        });
        $(element).popover('show');
        return false;
      } else {
        return true;
      }
    });

    // display popup on click
    map.on('click', function(evt) {
      var element = popup.getElement();
      var feature = map.forEachFeatureAtPixel(evt.pixel,
        function(feature, layer) {
          return feature;
        }
      );
      if (feature) {
        var coord = evt.coordinate;
        popup.setPosition(coord);
        var geometry = feature.getGeometry();
        $(element).popover({
          'placement': 'top',
          'animation': false,
          'html': true,
          'content': '<p>' + feature.getProperties()['name'] + '</p>'
        });
        $(element).popover('show');
      } else {
        removePopup();
      }
    });

    var removePopup = function() {
      var element = popup.getElement();
      $(element).popover('destroy');
    }

    // change mouse cursor when over marker
    $(map.getViewport()).on('mousemove', function(e) {
      if (map.getTarget().style) {
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
          return true;
        });
        if (hit) {
          map.getTarget().style.cursor = 'pointer';
        } else {
          map.getTarget().style.cursor = '';
        }
      }
    });

  </script>
</body>

</html>
