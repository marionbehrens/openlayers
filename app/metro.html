<!DOCTYPE html>
<html>
<head>
<title>berlin_metro</title>
<meta http-equiv="imagetoolbar" content="no"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<style type="text/css">
.map {
  width: 100%; height: 400px;
}
.edit-form input[type="button"] {
  float: left;
}
</style>
<link rel="stylesheet" href="../bower_components/openlayers3/ol.css" type="text/css">
<script src="../bower_components/openlayers3/ol.js" type="text/javascript"></script>
<script src="../bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
<script src="./polygon.js" type="text/javascript"></script>
<script src="./points.js" type="text/javascript"></script>
<script src="./geojson.js" type="text/javascript"></script>
</head>
<body>
<div id="map" class="map"></div>
<div id="mouse-position"></div>
<div class="edit-form">
  <input id="switch-projection" type="button" value="Switch" />
</div>
<script type="text/javascript">
var imageMapExtent = [0.000000, -4437.000000, 6445.000000, 0.000000];
// var osmMapExtent = [13.0, 52.115.000000, 13.8, 52.915]; // 13.400, 52.515
var mapMinZoom = 0;
var mapMaxZoom = 5;
var mapMaxResolution = 1.000000;
var tileExtent = [0.000000, -4437.000000, 6445.000000, 0.000000];

var mapResolutions = [];
for (var z = mapMinZoom; z <= mapMaxZoom; z++) {
  mapResolutions.push(Math.pow(2, mapMaxZoom - z) * mapMaxResolution);  
}

var mapTileGrid = new ol.tilegrid.TileGrid({
  extent: tileExtent,
  minZoom: mapMinZoom,
  resolutions: mapResolutions
});

var imageLayer =  new ol.layer.Tile({
      source: new ol.source.XYZ({
        projection: 'PIXELS',
        tileGrid: mapTileGrid,
        url: "{z}/{x}/{y}.png"
      })
    });

var imageView = new ol.View({
  projection: ol.proj.get('PIXELS'),
  extent: imageMapExtent,
  maxResolution: mapTileGrid.getResolution(0)
});

var osmLayer = new ol.layer.Tile({ 
  source: new ol.source.OSM()
});

var osmView = new ol.View({ 
  // projection: 'EPSG:4326',
  center: ol.proj.transform([13.400, 52.515],'EPSG:4326','EPSG:3857'),
  zoom: 11
});

var map;

var projection = 'PIXELS';

var mousePosition = new ol.control.MousePosition({
  coordinateFormat: ol.coordinate.createStringXY(4),
  projection: 'PIXELS',
  // comment the following two lines to have the mouse position
  // be placed within the map.
  className: 'custom-mouse-position',
  target: document.getElementById('mouse-position'),
  undefinedHTML: '&nbsp;'
});

var mousePositionControl = ol.control.defaults({
  attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
    collapsible: false
  })
}).extend([mousePosition]);

var currentLayers = [];

var switchProjection = function() {
  if (map) {
    if (currentLayers.length > 0)
      currentLayers.forEach(function(layer){ map.removeLayer(layer);});
      currentLayers = [];
  }
  else {
    map = new ol.Map({
      target: 'map',
      renderer: 'canvas',
      layers: [],
      controls: ol.control.defaults({
        attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
          collapsible: false
        })
      }).extend([mousePosition, new ol.control.OverviewMap()])
    });
  }
  if (projection == 'PIXELS') {
    map.setView(osmView);
    mousePosition.setProjection(ol.proj.get('EPSG:4326'));
    currentLayers.push(osmLayer);
    currentLayers.push(getPolygonLayer('EPSG:3857'));
    currentLayers.push(getGeoJsonLayer('EPSG:3857'));
    projection = 'EPSG:3857';
  }
  else {
    map.setView(imageView);
    mousePosition.setProjection(ol.proj.get('PIXELS'));
    currentLayers.push(imageLayer);
    currentLayers.push(vectorLayer);
    currentLayers.push(getPolygonLayer('PIXELS'));
    currentLayers.push(getGeoJsonLayer('PIXELS'));
    map.getView().fit(imageMapExtent, map.getSize());
    projection = 'PIXELS';
  }
  currentLayers.forEach(function(layer){ 
    map.addLayer(layer);
  });
}

switchProjection();

$('#switch-projection').click(function() { 
  switchProjection();
});
</script>
</body>
</html>
