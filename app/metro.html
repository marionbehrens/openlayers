<!DOCTYPE html>
<html>

<head>
  <title>berlin_metro</title>
  <meta http-equiv="imagetoolbar" content="no" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style type="text/css">
    .popover-content {
      min-width: 180px;
    }
    .map {
      width: 100%;
      height: 400px;
    }
    .edit-form input {
      float: left;
    }
  </style>
  <link rel="stylesheet" href="../bower_components/openlayers3/ol.css" type="text/css">
  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
  <script src="../bower_components/openlayers3/ol-debug.js" type="text/javascript"></script>
  <script src="../bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
  <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="./polygon.js" type="text/javascript"></script>
  <script src="./points.js" type="text/javascript"></script>
  <script src="./geojson.js" type="text/javascript"></script>
  <script src="./selection.js" type="text/javascript"></script>
</head>

<body>
  <div id="map" class="map"></div>
  <div style="display: none;">
    <div id="popup" title="Welcome to ol3"></div>
  </div>
  <div class="row">
    <div class="col-md-2">
      <div id="mouse-position"></div>
    </div>
    <div class="col-md-10">
      <div id="draw-interaction-points"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-1  col-md-offset-1">
      <input id="switch-projection" type="button" value="Switch" />
    </div>
    <div class="col-md-1">
      <input id="toggle-debug" type="checkbox" /> Debug-Mode
    </div>
    <div class="col-md-1">
      <input id="toggle-select" type="checkbox" /> Select-Mode
    </div>
  </div>
  <script type="text/javascript">

    var imageMapExtent = [0.000000, -4437.000000, 6445.000000, 0.000000];
    // var osmMapExtent = [13.0, 52.115.000000, 13.8, 52.915]; // 13.400, 52.515
    var mapMinZoom = 0;
    var mapMaxZoom = 5;
    var mapMaxResolution = 1.000000;
    var tileExtent = [0.000000, -4437.000000, 6445.000000, 0.000000];

    var mapResolutions = [];
    for (var z = mapMinZoom; z <= mapMaxZoom; z++) {
      mapResolutions.push(Math.pow(2, mapMaxZoom - z) * mapMaxResolution);
    }

    var mapTileGrid = new ol.tilegrid.TileGrid({
      extent: tileExtent,
      minZoom: mapMinZoom,
      resolutions: mapResolutions
    });

    var imageLayer = new ol.layer.Tile({
      source: new ol.source.XYZ({
        projection: 'PIXELS',
        tileGrid: mapTileGrid,
        url: "{z}/{x}/{y}.png"
      })
    });

    var imageView = new ol.View({
      projection: ol.proj.get('PIXELS'),
      extent: imageMapExtent,
      maxResolution: mapTileGrid.getResolution(0)
    });

    var osmLayer = new ol.layer.Tile({
      source: new ol.source.OSM()
    });

    var osmView = new ol.View({
      // projection: 'EPSG:4326',
      center: ol.proj.transform([13.400, 52.515], 'EPSG:4326', 'EPSG:3857'),
      zoom: 11
    });

    var map;

    var projection = 'PIXELS';

    var mousePosition = new ol.control.MousePosition({
      coordinateFormat: ol.coordinate.createStringXY(4),
      projection: 'PIXELS',
      // comment the following two lines to have the mouse position
      // be placed within the map.
      className: 'custom-mouse-position',
      target: document.getElementById('mouse-position'),
      undefinedHTML: '&nbsp;'
    });

    var mousePositionControl = ol.control.defaults({
      attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
        collapsible: false
      })
    }).extend([mousePosition]);

    var popup = new ol.Overlay({
      element: document.getElementById('popup')
    });

    var geoJsonLayer;

    var switchProjection = function() {
      if (map) {
        $('#toggle-debug').prop("checked", false);
        isDebug = false;
        removePopup();
        $('#toggle-select').prop("checked", false);
        removeInteraction();
      } else {
        map = new ol.Map({
          target: 'map',
          renderer: 'canvas',
          layers: [],
          controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
              collapsible: false
            })
          }).extend([mousePosition, new ol.control.OverviewMap()])
        });
        map.addOverlay(popup);
      }
      if (projection == 'PIXELS') {
        map.removeLayer(imageLayer);
        map.removeLayer(geoJsonLayer);
        map.setView(osmView);
        mousePosition.setProjection(ol.proj.get('EPSG:4326'));
        geoJsonLayer = getGeoJsonLayer('EPSG:3857');
        map.addLayer(osmLayer);
        map.addLayer(geoJsonLayer);
        projection = 'EPSG:3857';
      } else {
        map.removeLayer(osmLayer);
        map.removeLayer(geoJsonLayer);
        map.setView(imageView);
        mousePosition.setProjection(ol.proj.get('PIXELS'));
        map.addLayer(imageLayer);
        geoJsonLayer = getGeoJsonLayer('PIXELS');
        map.addLayer(geoJsonLayer);
        map.getView().fit(imageMapExtent, map.getSize());
        projection = 'PIXELS';
      }
    }

    var drawInteractionFeatures = new ol.Collection();
    drawInteractionFeatures.on('add', function(evt) {
      var element = document.getElementById('draw-interaction-points');
      var isFirst = true;
      geoJsonLayer.getSource().forEachFeature(function(feature) {
        if (isPointInPolygon(feature.getGeometry().getCoordinates(), evt.element.getGeometry().getCoordinates()[0])) {
          if (isFirst && element.hasChildNodes()) {
            element.appendChild(document.createElement('br'));
          }
          isFirst = false;
          var content = document.createTextNode(feature.getProperties()['name'] + ';');
          element.appendChild(content);
        }
      });
      if (isFirst) {
        element.appendChild(document.createElement('br'));
        element.appendChild(document.createTextNode('-'));
      }
    });
    var drawOverlaySource = new ol.source.Vector({ features: drawInteractionFeatures });
    var drawOverlay = new ol.layer.Vector({
      source: drawOverlaySource,
      style: new ol.style.Style({
        fill: new ol.style.Fill({
          color: 'rgba(255, 255, 255, 0.2)'
        }),
        stroke: new ol.style.Stroke({
          color: '#ffcc33',
          width: 2
        }),
        image: new ol.style.Circle({
          radius: 7,
          fill: new ol.style.Fill({
            color: '#ffcc33'
          })
        })
      })
    });
    var drawInteraction = new ol.interaction.Draw({
      type: 'Polygon',
      features: drawInteractionFeatures
    });
    var drawInteractionModify = new ol.interaction.Modify({
      features: drawInteractionFeatures,
      // the SHIFT key must be pressed to delete vertices, so
      // that new vertices can be drawn at the same position
      // of existing vertices
      deleteCondition: function(event) {
        return ol.events.condition.shiftKeyOnly(event) &&
            ol.events.condition.singleClick(event);
      }
    });

    function addInteraction() {
      isDebug = false;
      if (map) {
        drawOverlay.setMap(map); // instead of: map.addLayer(drawOverlay);
        // 'draw-interaction-points'
        map.addInteraction(drawInteraction);
        map.addInteraction(drawInteractionModify);
      }
    }

    function removeInteraction() {
      drawInteractionFeatures.clear();
      if (map) {
        map.removeInteraction(drawInteraction);
        map.removeInteraction(drawInteractionModify);
        drawOverlay.setMap(null); // instead of: map.removeLayer(drawOverlay);
      }
      var element = document.getElementById('draw-interaction-points');
      while (element.firstChild) {
        element.removeChild(element.firstChild);
      }
    }

    switchProjection();

    $('#switch-projection').click(function() {
      switchProjection();
    });

    var isDebug = false;

    $('#toggle-debug').click(function() {
      isDebug = $('#toggle-debug').prop("checked");
    });

    $('#toggle-select').click(function() {
      if ($('#toggle-select').prop("checked")) {
        removePopup();
        addInteraction();
      } else {
        removeInteraction();
      }
    });

    map.on('dblclick', function(evt) {
      console.log(isDebug);
      if (isDebug) {
        var element = popup.getElement();
        var coord = evt.coordinate;
        removePopup();
        popup.setPosition(coord);
        if (projection == 'EPSG:3857') {
          coord = ol.proj.transform(coord, 'EPSG:3857', 'EPSG:4326');
        }
        $(element).popover({
          'placement': 'top',
          'animation': false,
          'html': true,
          'content': '<p>{<br>&nbsp;\"type\":\"Feature\",<br>&nbsp;\"properties\": {<br>&nbsp;&nbsp;\"name\": \"XYZ\"<br>&nbsp;},<br>&nbsp;\"geometry\": {<br>&nbsp;&nbsp;\"type\": \"Point\",<br>&nbsp;&nbsp;\"coordinates\": [<br>&nbsp;&nbsp;&nbsp;' + coord[0] + ',<br>&nbsp;&nbsp;&nbsp;' + coord[1] + '<br>&nbsp;&nbsp;]<br>&nbsp;}<br>}</p>'
        });
        $(element).popover('show');
        return false;
      } else {
        return true;
      }
    });

    // display popup on click
    map.on('click', function(evt) {
      var isDrawInteractionActive = false;
      map.getInteractions().forEach(function(interaction) {
        if (drawInteraction == interaction) {
          isDrawInteractionActive = true;
        }
      });
      if (!isDrawInteractionActive) {
        var element = popup.getElement();
        var feature = map.forEachFeatureAtPixel(evt.pixel,
          function(feature, layer) {
            return feature;
          }
        );
        if (feature) {
          var coord = evt.coordinate;
          popup.setPosition(coord);
          var geometry = feature.getGeometry();
          $(element).popover({
            'placement': 'top',
            'animation': false,
            'html': true,
            'content': '<p>' + feature.getProperties()['name'] + '</p>'
          });
          $(element).popover('show');
        } else {
          removePopup();
        }
      }
    });

    var removePopup = function() {
      var element = popup.getElement();
      $(element).popover('destroy');
    }

    // change mouse cursor when over marker
    $(map.getViewport()).on('mousemove', function(e) {
      if (map.getTarget().style) {
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
          return true;
        });
        if (hit) {
          map.getTarget().style.cursor = 'pointer';
        } else {
          map.getTarget().style.cursor = '';
        }
      }
    });

  </script>
</body>

</html>
